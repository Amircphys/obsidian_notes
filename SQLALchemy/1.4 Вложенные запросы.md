
SQL –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã. –í–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–ø–æ–¥–∑–∞–ø—Ä–æ—Å, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∑–∞–ø—Ä–æ—Å) ‚Äì —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ SQL.

–í–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è¬†–¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —É—Å–ª–æ–≤–∏–∏ –æ—Ç–±–æ—Ä–∞ –∑–∞–ø–∏—Å–µ–π –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.¬†–ï–≥–æ –ø—Ä–∏–º–µ–Ω—è—é—Ç¬†–¥–ª—è:

- —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞;
- –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–æ–≥–æ, –≤–∫–ª—é—á–µ–Ω–æ –ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞;
- –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–≥–æ, –≤—ã–±–∏—Ä–∞–µ—Ç –ª–∏ –∑–∞–ø—Ä–æ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ¬†—Å—Ç—Ä–æ–∫–∏.
```sql
SELECT title, author, price, amount 
FROM book 
WHERE price = ( SELECT MIN(price) FROM book );

SELECT title, author, amount 
FROM book 
WHERE ABS(amount - (SELECT AVG(amount) FROM book)) >3;


SELECT title, author, amount, price 
FROM book 
WHERE author IN ( SELECT author FROM book GROUP BY author HAVING SUM(amount) >= 12 );

SELECT title, author, amount, price 
FROM book 
WHERE author IN 
(
 SELECT author 
 FROM book 
 GROUP BY author 
 HAVING SUM(amount) >= 12
);

SELECT title, author, amount, price 
FROM book 
WHERE amount < ALL ( 
	SELECT AVG(amount) 
	FROM book 
	GROUP BY author 
);
```


# –ò–∑—É—á–µ–Ω–∏–µ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ SQLAlchemy 2.0

  

–û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π—Ç–µ –∏–∑—É—á–∏–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤) –≤ SQLAlchemy 2.0. –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤–∏–º –Ω–µ–±–æ–ª—å—à—É—é –æ—à–∏–±–∫—É –≤ –≤–∞—à–µ–º –∫–æ–¥–µ –∏ –¥–æ–±–∞–≤–∏–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –∏–º–ø–æ—Ä—Ç:

  

```python

from decimal import Decimal # –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç

from sqlalchemy import create_engine, OperationalError

  

# –ò—Å–ø—Ä–∞–≤—å—Ç–µ data - –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–ø—è—Ç—ã–µ –º–µ–∂–¥—É —Å–ª–æ–≤–∞—Ä—è–º–∏

data = [

{'title': '–ú–∞—Å—Ç–µ—Ä –∏ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞', 'author': '–ë—É–ª–≥–∞–∫–æ–≤ –ú.–ê.', 'price': Decimal('670.99'), 'amount': 4},

{'title': '–ë–µ–ª–∞—è –≥–≤–∞—Ä–¥–∏—è', 'author': '–ë—É–ª–≥–∞–∫–æ–≤ –ú.–ê.', 'price': Decimal('540.50'), 'amount': 5},

{'title': '–ò–¥–∏–æ—Ç', 'author': '–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π –§.–ú.', 'price': Decimal('460.00'), 'amount': 10},

{'title': '–ë—Ä–∞—Ç—å—è –ö–∞—Ä–∞–º–∞–∑–æ–≤—ã', 'author': '–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π –§.–ú.', 'price': Decimal('799.01'), 'amount': 2},

{'title': '–ò–≥—Ä–æ–∫', 'author': '–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π –§.–ú.', 'price': Decimal('480.50'), 'amount': 10},

{'title': '–°—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏—è –∏ –ø–æ—ç–º—ã', 'author': '–ï—Å–µ–Ω–∏–Ω –°.–ê.', 'price': Decimal('650.00'), 'amount': 15},

{'title': 'Test title', 'author': 'Test author', 'price': None, 'amount': 0}

]

```

  

–¢–µ–ø–µ—Ä—å –ø—Ä–∏—Å—Ç—É–ø–∏–º –∫ –∏–∑—É—á–µ–Ω–∏—é –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:

  

## 1. –í–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ

  

–í–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ (—Å–∫–∞–ª—è—Ä–Ω—ã–π –ø–æ–¥–∑–∞–ø—Ä–æ—Å), –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ –Ω–∞–º –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.

  

```python

from sqlalchemy import select, func

  

def scalar_subquery_examples():

"""

–ü—Ä–∏–º–µ—Ä—ã —Å–∫–∞–ª—è—Ä–Ω—ã—Ö –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ - –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ

"""

with engine.connect() as conn:

# –ü—Ä–∏–º–µ—Ä 1: –ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏ —Å —Ü–µ–Ω–æ–π –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–π

# –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –ø–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã

avg_price_subquery = select(func.avg(book.c.price)).scalar_subquery()

# –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞

query = select(

book.c.title,

book.c.author,

book.c.price

).where(

book.c.price > avg_price_subquery # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞

)

print("üìö –ö–Ω–∏–≥–∏ —Å —Ü–µ–Ω–æ–π –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–π:")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.title} - {row.author} - {row.price}")

print("\n" + "="*50 + "\n")

# –ü—Ä–∏–º–µ—Ä 2: –ù–∞–π—Ç–∏ –∞–≤—Ç–æ—Ä–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–Ω–∏–≥

# –ü–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥ —É –∞–≤—Ç–æ—Ä–∞

max_books_count = select(

func.count(book.c.book_id)

).group_by(

book.c.author

).order_by(

func.count(book.c.book_id).desc()

).limit(1).scalar_subquery()

# –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å –Ω–∞—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ—Ä–æ–≤ —Å —ç—Ç–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–Ω–∏–≥

query = select(

book.c.author,

func.count(book.c.book_id).label('book_count')

).group_by(

book.c.author

).having(

func.count(book.c.book_id) == max_books_count

)

print("üë§ –ê–≤—Ç–æ—Ä(—ã) —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–Ω–∏–≥:")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.author} - {row.book_count} –∫–Ω–∏–≥(–∏)")

  

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–∞

scalar_subquery_examples()

```

  

## 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏–∏

  

–ü–æ–¥–∑–∞–ø—Ä–æ—Å—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —á–∞—Å—Ç—è—Ö SQL-–≤—ã—Ä–∞–∂–µ–Ω–∏–π: –≤ SELECT, WHERE, HAVING –∏ –¥—Ä—É–≥–∏—Ö.

  

```python

def subquery_in_expressions():

"""

–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏—è—Ö

"""

with engine.connect() as conn:

# –ü—Ä–∏–º–µ—Ä 1: –ü–æ–¥–∑–∞–ø—Ä–æ—Å –≤ SELECT –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã

avg_price = select(func.avg(book.c.price)).scalar_subquery()

query = select(

book.c.title,

book.c.price,

# –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–æ—Å—Ç—å –º–µ–∂–¥—É —Ü–µ–Ω–æ–π –∫–Ω–∏–≥–∏ –∏ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω–æ–π

(book.c.price - avg_price).label('price_diff_from_avg')

).where(

book.c.price.is_not(None) # –ò—Å–∫–ª—é—á–∞–µ–º –∫–Ω–∏–≥–∏ –±–µ–∑ —Ü–µ–Ω—ã

)

print("üìä –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏ –æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã:")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.title}: {row.price} (–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: {row.price_diff_from_avg:+.2f})")

print("\n" + "="*50 + "\n")

# –ü—Ä–∏–º–µ—Ä 2: –ü–æ–¥–∑–∞–ø—Ä–æ—Å –≤ WHERE –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–Ω–∏–≥ –¥–æ—Ä–æ–∂–µ —Å–∞–º–æ–π –¥–µ—à–µ–≤–æ–π –∫–Ω–∏–≥–∏ –ë—É–ª–≥–∞–∫–æ–≤–∞

bulgakov_min_price = select(

func.min(book.c.price)

).where(

book.c.author == '–ë—É–ª–≥–∞–∫–æ–≤ –ú.–ê.'

).scalar_subquery()

query = select(

book.c.title,

book.c.author,

book.c.price

).where(

# –£—Å–ª–æ–≤–∏–µ: —Ü–µ–Ω–∞ –±–æ–ª—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∫–Ω–∏–≥–∏ –ë—É–ª–≥–∞–∫–æ–≤–∞

book.c.price > bulgakov_min_price

).order_by(

book.c.price

)

print("üí∞ –ö–Ω–∏–≥–∏ –¥–æ—Ä–æ–∂–µ —Å–∞–º–æ–π –¥–µ—à–µ–≤–æ–π –∫–Ω–∏–≥–∏ –ë—É–ª–≥–∞–∫–æ–≤–∞:")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.title} - {row.author} - {row.price}")

print("\n" + "="*50 + "\n")

# –ü—Ä–∏–º–µ—Ä 3: –ü–æ–¥–∑–∞–ø—Ä–æ—Å –≤ HAVING –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏

avg_amount = select(func.avg(book.c.amount)).scalar_subquery()

query = select(

book.c.author,

func.count(book.c.book_id).label('book_count'),

func.sum(book.c.amount).label('total_amount')

).group_by(

book.c.author

).having(

# –£—Å–ª–æ–≤–∏–µ: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –∞–≤—Ç–æ—Ä–∞ –±–æ–ª—å—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ

func.sum(book.c.amount) > avg_amount

)

print("üìö –ê–≤—Ç–æ—Ä—ã —Å –æ–±—â–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–Ω–∏–≥ –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ:")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.author}: {row.book_count} –Ω–∞–∑–≤–∞–Ω–∏–π, {row.total_amount} —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤")

  

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–∞

subquery_in_expressions()

```

  

## 3. –í–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º IN

  

–û–ø–µ—Ä–∞—Ç–æ—Ä IN –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –º–Ω–æ–∂–µ—Å—Ç–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞.

  

```python

def subquery_with_in_operator():

"""

–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º IN

"""

with engine.connect() as conn:

# –ü—Ä–∏–º–µ—Ä 1: –ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏ –∞–≤—Ç–æ—Ä–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –∫–Ω–∏–≥–∏ –¥–æ—Ä–æ–∂–µ 600

# –ü–æ–¥–∑–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–æ–≤ —Å –∫–Ω–∏–≥–∞–º–∏ –¥–æ—Ä–æ–∂–µ 600

expensive_authors_subquery = select(

book.c.author

).where(

book.c.price > 600

).distinct() # DISTINCT —É–±–∏—Ä–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã

# –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å –∏—â–µ—Ç –≤—Å–µ –∫–Ω–∏–≥–∏ —ç—Ç–∏—Ö –∞–≤—Ç–æ—Ä–æ–≤

query = select(

book.c.title,

book.c.author,

book.c.price

).where(

book.c.author.in_(expensive_authors_subquery) # –ò—Å–ø–æ–ª—å–∑—É–µ–º .in_()

).order_by(

book.c.author,

book.c.price

)

print("üìö –í—Å–µ –∫–Ω–∏–≥–∏ –∞–≤—Ç–æ—Ä–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –∫–Ω–∏–≥–∏ –¥–æ—Ä–æ–∂–µ 600:")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.title} - {row.author} - {row.price}")

print("\n" + "="*50 + "\n")

# –ü—Ä–∏–º–µ—Ä 2: –ù–∞–π—Ç–∏ –∞–≤—Ç–æ—Ä–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –≤ –Ω–∞–ª–∏—á–∏–∏

# —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–¥–Ω–æ–º—É –∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤ (5, 10, 15)

popular_amounts_subquery = select(

book.c.amount

).where(

book.c.amount.in_([5, 10, 15]) # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—ã–π —Å–ø–∏—Å–æ–∫

).distinct()

query = select(

book.c.author,

book.c.title,

book.c.amount

).where(

book.c.amount.in_(popular_amounts_subquery)

).order_by(

book.c.amount.desc(),

book.c.author

)

print("üìä –ö–Ω–∏–≥–∏ —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞–º–∏ –≤ –Ω–∞–ª–∏—á–∏–∏ (5, 10, 15):")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.author} - {row.title} - {row.amount} —ç–∫–∑.")

print("\n" + "="*50 + "\n")

# –ü—Ä–∏–º–µ—Ä 3: –ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏, —Ü–µ–Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ —Ü–µ–Ω –∫–Ω–∏–≥ –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ

dostoevsky_prices_subquery = select(

book.c.price

).where(

book.c.author == '–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π –§.–ú.'

)

query = select(

book.c.title,

book.c.author,

book.c.price

).where(

book.c.price.in_(dostoevsky_prices_subquery)

).order_by(

book.c.price

)

print("üí∞ –ö–Ω–∏–≥–∏ —Å —Ü–µ–Ω–∞–º–∏, –∫–∞–∫ —É –∫–Ω–∏–≥ –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ:")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.title} - {row.author} - {row.price}")

  

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–∞

subquery_with_in_operator()

```

  

## 4. –í–ª–æ–∂–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ ANY –∏ ALL

  

–û–ø–µ—Ä–∞—Ç–æ—Ä—ã ANY –∏ ALL –ø–æ–∑–≤–æ–ª—è—é—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞.

  

```python

def subquery_with_any_all():

"""

–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ ANY –∏ ALL

"""

with engine.connect() as conn:

# –ü—Ä–∏–º–µ—Ä 1: ANY - –Ω–∞–π—Ç–∏ –∫–Ω–∏–≥–∏ –¥–æ—Ä–æ–∂–µ –ª—é–±–æ–π (—Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π) –∫–Ω–∏–≥–∏ –ï—Å–µ–Ω–∏–Ω–∞

# ANY –æ–∑–Ω–∞—á–∞–µ—Ç "–±–æ–ª—å—à–µ —á–µ–º —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞"

esenin_prices_subquery = select(

book.c.price

).where(

book.c.author == '–ï—Å–µ–Ω–∏–Ω –°.–ê.'

)

query = select(

book.c.title,

book.c.author,

book.c.price

).where(

book.c.price > esenin_prices_subquery.any_() # –ò—Å–ø–æ–ª—å–∑—É–µ–º any_()

).order_by(

book.c.price

)

print("üìö –ö–Ω–∏–≥–∏ –¥–æ—Ä–æ–∂–µ –ª—é–±–æ–π (—Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π) –∫–Ω–∏–≥–∏ –ï—Å–µ–Ω–∏–Ω–∞:")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.title} - {row.author} - {row.price}")

print("\n" + "="*50 + "\n")

# –ü—Ä–∏–º–µ—Ä 2: ALL - –Ω–∞–π—Ç–∏ –∫–Ω–∏–≥–∏ –¥–æ—Ä–æ–∂–µ –≤—Å–µ—Ö –∫–Ω–∏–≥ –ë—É–ª–≥–∞–∫–æ–≤–∞

# ALL –æ–∑–Ω–∞—á–∞–µ—Ç "–±–æ–ª—å—à–µ —á–µ–º –≤—Å–µ"

bulgakov_prices_subquery = select(

book.c.price

).where(

book.c.author == '–ë—É–ª–≥–∞–∫–æ–≤ –ú.–ê.'

)

query = select(

book.c.title,

book.c.author,

book.c.price

).where(

book.c.price > bulgakov_prices_subquery.all_() # –ò—Å–ø–æ–ª—å–∑—É–µ–º all_()

).order_by(

book.c.price

)

print("üí∞ –ö–Ω–∏–≥–∏ –¥–æ—Ä–æ–∂–µ –≤—Å–µ—Ö –∫–Ω–∏–≥ –ë—É–ª–≥–∞–∫–æ–≤–∞:")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.title} - {row.author} - {row.price}")

print("\n" + "="*50 + "\n")

# –ü—Ä–∏–º–µ—Ä 3: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ ANY –∏ ALL –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥

# –ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ ANY –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥ –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ

dostoevsky_amounts_any = select(

book.c.amount

).where(

book.c.author == '–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π –§.–ú.'

)

query_any = select(

book.c.title,

book.c.author,

book.c.amount

).where(

book.c.amount > dostoevsky_amounts_any.any_()

).order_by(

book.c.amount

)

print("üìä –ö–Ω–∏–≥–∏ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –±–æ–ª—å—à–µ ANY –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥ –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ:")

result = conn.execute(query_any)

for row in result:

print(f" ‚Ä¢ {row.title} - {row.author} - {row.amount} —ç–∫–∑.")

print("\n" + "-"*30 + "\n")

# –ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ ALL –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥ –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ

dostoevsky_amounts_all = select(

book.c.amount

).where(

book.c.author == '–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π –§.–ú.'

)

query_all = select(

book.c.title,

book.c.author,

book.c.amount

).where(

book.c.amount > dostoevsky_amounts_all.all_()

).order_by(

book.c.amount

)

print("üìä –ö–Ω–∏–≥–∏ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –±–æ–ª—å—à–µ ALL –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥ –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ:")

result = conn.execute(query_all)

for row in result:

print(f" ‚Ä¢ {row.title} - {row.author} - {row.amount} —ç–∫–∑.")

  

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–∞

subquery_with_any_all()

```

  

## 5. –í–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ SELECT

  

–ü–æ–¥–∑–∞–ø—Ä–æ—Å—ã –≤ SELECT –ø–æ–∑–≤–æ–ª—è—é—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å—Ç–æ–ª–±—Ü—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥—Ä—É–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

  

```python

def subquery_in_select():

"""

–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —á–∞—Å—Ç–∏ SELECT

"""

with engine.connect() as conn:

# –ü—Ä–∏–º–µ—Ä 1: –î–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏ –ø–æ–∫–∞–∑–∞—Ç—å, —Å–∫–æ–ª—å–∫–æ –∫–Ω–∏–≥ —Ç–æ–≥–æ –∂–µ –∞–≤—Ç–æ—Ä–∞

same_author_count_subquery = select(

func.count(book.c.book_id)

).where(

book.c.author == book.c.author # –≠—Ç–æ –±—É–¥–µ—Ç —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ correlate

).correlate(book).scalar_subquery()

# –ë–æ–ª–µ–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–ª–∏–∞—Å–æ–≤

book_main = book.alias('book_main')

book_sub = book.alias('book_sub')

same_author_count = select(

func.count(book_sub.c.book_id)

).where(

book_sub.c.author == book_main.c.author

).scalar_subquery()

query = select(

book_main.c.title,

book_main.c.author,

book_main.c.price,

same_author_count.label('books_by_same_author')

).order_by(

book_main.c.author,

book_main.c.title

)

print("üìö –ö–Ω–∏–≥–∏ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–Ω–∏–≥ —Ç–æ–≥–æ –∂–µ –∞–≤—Ç–æ—Ä–∞:")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.title} - {row.author} - {row.price} "

f"(–∫–Ω–∏–≥ –∞–≤—Ç–æ—Ä–∞: {row.books_by_same_author})")

print("\n" + "="*50 + "\n")

# –ü—Ä–∏–º–µ—Ä 2: –î–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–Ω–æ—Å—Ç—å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω–æ–π

max_price_subquery = select(

func.max(book.c.price)

).scalar_subquery()

query = select(

book.c.title,

book.c.author,

book.c.price,

(max_price_subquery - book.c.price).label('diff_from_max_price')

).where(

book.c.price.is_not(None)

).order_by(

book.c.price.desc()

)

print("üí∞ –ö–Ω–∏–≥–∏ —Å —Ä–∞–∑–Ω–æ—Å—Ç—å—é –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã:")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.title} - {row.author} - {row.price} "

f"(–¥–æ –º–∞–∫—Å.: {row.diff_from_max_price})")

print("\n" + "="*50 + "\n")

# –ü—Ä–∏–º–µ—Ä 3: –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Ä–∞ –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –∫–Ω–∏–≥ –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞

total_books_subquery = select(

func.count(book.c.book_id)

).scalar_subquery()

query = select(

book.c.author,

func.count(book.c.book_id).label('author_books'),

total_books_subquery.label('total_books'),

# –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç (—É–º–Ω–æ–∂–∞–µ–º –Ω–∞ 100.0 –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤)

(func.count(book.c.book_id) * 100.0 / total_books_subquery).label('percentage')

).group_by(

book.c.author

).order_by(

func.count(book.c.book_id).desc()

)

print("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–≤—Ç–æ—Ä–∞–º (–ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥):")

result = conn.execute(query)

for row in result:

print(f" ‚Ä¢ {row.author}: {row.author_books} –∏–∑ {row.total_books} "

f"({row.percentage:.1f}%)")

  

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–∞

subquery_in_select()

```

  

## –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Å –∑–∞–ø—É—Å–∫–æ–º –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π

  

```python

def run_all_examples():

"""

–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

"""

print("üöÄ –ò–ó–£–ß–ï–ù–ò–ï –í–õ–û–ñ–ï–ù–ù–´–• –ó–ê–ü–†–û–°–û–í –í SQLAlchemy 2.0")

print("="*60)

print("\n1Ô∏è‚É£ –°–ö–ê–õ–Ø–†–ù–´–ï –ü–û–î–ó–ê–ü–†–û–°–´ (–≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ)")

print("="*60)

scalar_subquery_examples()

print("\n2Ô∏è‚É£ –ü–û–î–ó–ê–ü–†–û–°–´ –í –í–´–†–ê–ñ–ï–ù–ò–Ø–•")

print("="*60)

subquery_in_expressions()

print("\n3Ô∏è‚É£ –ü–û–î–ó–ê–ü–†–û–°–´ –° –û–ü–ï–†–ê–¢–û–†–û–ú IN")

print("="*60)

subquery_with_in_operator()

print("\n4Ô∏è‚É£ –ü–û–î–ó–ê–ü–†–û–°–´ –° –û–ü–ï–†–ê–¢–û–†–ê–ú–ò ANY –ò ALL")

print("="*60)

subquery_with_any_all()

print("\n5Ô∏è‚É£ –ü–û–î–ó–ê–ü–†–û–°–´ –í SELECT")

print("="*60)

subquery_in_select()

print("\n‚úÖ –í–°–ï –ü–†–ò–ú–ï–†–´ –í–´–ü–û–õ–ù–ï–ù–´ –£–°–ü–ï–®–ù–û!")

  

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –ø—Ä–∏–º–µ—Ä–æ–≤

run_all_examples()

```

  

## –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:

  

1. **–°–∫–∞–ª—è—Ä–Ω—ã–µ –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å `.scalar_subquery()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è

2. **–û–ø–µ—Ä–∞—Ç–æ—Ä IN** —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `.in_(–ø–æ–¥–∑–∞–ø—Ä–æ—Å)`

3. **–û–ø–µ—Ä–∞—Ç–æ—Ä—ã ANY/ALL** –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ `.any_()` –∏ `.all_()`

4. **–ü–æ–¥–∑–∞–ø—Ä–æ—Å—ã –≤ SELECT** –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å—Ç–æ–ª–±—Ü—ã

5. **–ê–ª–∏–∞—Å—ã —Ç–∞–±–ª–∏—Ü** –ø–æ–º–æ–≥–∞—é—Ç –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö —Å –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞–º–∏

  

–≠—Ç–∏ –ø—Ä–∏–º–µ—Ä—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ SQLAlchemy 2.0. –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å —Å —ç—Ç–∏–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏, –∏–∑–º–µ–Ω—è–π—Ç–µ —É—Å–ª–æ–≤–∏—è –∏ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å–≤–æ–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã!


